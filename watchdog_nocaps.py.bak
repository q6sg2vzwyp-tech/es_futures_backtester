#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Watchdog (NO-CAPS weekly): hot-patches paper_trader.py to disable the weekly cap,
then launches the bot with your preferred args.

- Replaces an existing `weekly_cap_R = ...` with a disabled value, preserving indent.
- If not found, inserts right after `last_week_id = ...`, matching that line's indent.
- Creates a .bak once (first run) for safety.
- After patching, tries to compile paper_trader.py and warns on failure.
"""

import subprocess, sys, time, os, re, shutil

PY = r".venv\Scripts\python.exe"              # adjust if needed
SCRIPT = r"C:\Users\owner\Desktop\es_futures_backtester\paper_trader.py"
CWD = r"C:\Users\owner\Desktop\es_futures_backtester"

LAUNCH_ARGS = [
    "--place-orders",
    "--use-ib-pnl",
    "--local-symbol", "ESZ5",
    "--force-delayed",
    "--force-midpoint-rt",
    "--poll-hist-when-no-rt",
    "--rt-starve-sec", "2",
    "--trade-start-ct", "00:00",
    "--trade-end-ct", "23:59",
    "--host", "127.0.0.1",
    "--port", "7497",
    "--clientId", "360",
    "--risk-profile", "balanced",
    "--start-contracts", "1",
    "--max-contracts", "6",
    "--risk-pct", "0.01",
    "--risk-ticks", "12",
    "--tp-R", "1.0",
    "--margin-per-contract", "23000",
    "--margin-reserve-pct", "0.10",
    "--day-loss-cap-R", "1000000000",
    "--max-trades-per-day", "999999",
    "--max-consec-losses", "999999",
    "--day-guard-pct", "0",
    "--peak-dd-guard-pct", "0",
    "--pos-age-cap-sec", "315576000",
    "--pos-age-minR", "-1000000000",
]

WEEKLY_LINE_RE = re.compile(r'^(\s*)weekly_cap_R\s*=.*$', re.MULTILINE)
ANCHOR_RE      = re.compile(r'^(\s*)last_week_id\s*=\s*.+$', re.MULTILINE)
DISABLE_EXPR   = 'weekly_cap_R = float("-inf")  # patched by watchdog_nocaps'

def patch_weekly_cap_disable(path: str) -> bool:
    with open(path, "r", encoding="utf-8", newline="") as f:
        src = f.read()

    def _repl(m: re.Match) -> str:
        indent = m.group(1) or ""
        return f"{indent}{DISABLE_EXPR}"

    if WEEKLY_LINE_RE.search(src):
        new_src = WEEKLY_LINE_RE.sub(_repl, src)
        changed = (new_src != src)
        if changed:
            _maybe_backup(path)
            with open(path, "w", encoding="utf-8", newline="") as f:
                f.write(new_src)
        return changed

    m = ANCHOR_RE.search(src)
    if m:
        indent = m.group(1) or ""
        insert_at = m.end()
        patched = src[:insert_at] + f"\n{indent}{DISABLE_EXPR}\n" + src[insert_at:]
        _maybe_backup(path)
        with open(path, "w", encoding="utf-8", newline="") as f:
            f.write(patched)
        return True

    print("[watchdog_nocaps] WARNING: Could not locate weekly_cap_R or insertion anchor; no code change applied.")
    return False

def _maybe_backup(path: str):
    bak = path + ".bak"
    if not os.path.exists(bak):
        try:
            shutil.copy2(path, bak)
            print(f"[watchdog_nocaps] Backup created: {bak}")
        except Exception as e:
            print(f"[watchdog_nocaps] Backup failed (continuing): {e}")

def _compile_check(py_exe: str, path: str) -> bool:
    try:
        proc = subprocess.run([py_exe, "-m", "py_compile", path], cwd=CWD, capture_output=True, text=True)
        ok = (proc.returncode == 0)
        if not ok:
            print("[watchdog_nocaps] Compile failed:")
            if proc.stdout: print(proc.stdout.strip())
            if proc.stderr: print(proc.stderr.strip())
        return ok
    except Exception as e:
        print(f"[watchdog_nocaps] Compile check error (continuing): {e}")
        return True

def main():
    print("[watchdog_nocaps] Patching weekly cap…")
    changed = patch_weekly_cap_disable(SCRIPT)
    if changed:
        print("[watchdog_nocaps] Weekly cap disabled via code patch.")
    else:
        print("[watchdog_nocaps] No changes needed (already disabled or anchor not found).")

    if not _compile_check(PY, SCRIPT):
        print("[watchdog_nocaps] Not launching due to compile error (see above). Fix the file or restore the .bak.")
        return

    cmd = [PY, SCRIPT] + LAUNCH_ARGS
    print(f"[watchdog_nocaps] Launching: {cmd!r}")

    try:
        proc = subprocess.Popen(cmd, cwd=CWD)
        while True:
            ret = proc.poll()
            if ret is not None:
                print(f"[watchdog_nocaps] Child exited rc={ret}; restarting in 2s")
                time.sleep(2)
                patch_weekly_cap_disable(SCRIPT)
                if not _compile_check(PY, SCRIPT):
                    print("[watchdog_nocaps] Compile error after patch; waiting 5s before retry.")
                    time.sleep(5)
                    continue
                proc = subprocess.Popen(cmd, cwd=CWD)
            time.sleep(1.0)
    except KeyboardInterrupt:
        print("[watchdog_nocaps] Interrupted; exiting.")
        try: proc.terminate()
        except Exception: pass

if __name__ == "__main__":
    main()


